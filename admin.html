<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Maghuva Admin | Manage Collections</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link
        href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Poppins:wght@300;400;500;600&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --primary: #8B1538;
            --secondary: #D4AF37;
            --dark: #1A1A1A;
            --light: #FDFBF9;
            --gradient: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: var(--light);
            margin: 0;
            color: var(--dark);
        }

        .admin-header {
            background: var(--dark);
            color: white;
            padding: 2rem;
            text-align: center;
        }

        .container {
            max-width: 1000px;
            margin: 2rem auto;
            padding: 0 1rem;
        }

        /* Login Section */
        #setup-section {
            background: white;
            padding: 2.5rem;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .form-group input {
            width: 100%;
            padding: 0.8rem;
            border: 1px solid #ddd;
            border-radius: 10px;
            font-family: inherit;
        }

        .btn {
            background: var(--gradient);
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(139, 21, 56, 0.3);
        }

        /* Items Section */
        #admin-panel {
            display: none;
        }

        .item-card {
            background: white;
            padding: 1.5rem;
            border-radius: 15px;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 1.5rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            border-left: 5px solid var(--primary);
        }

        .item-card img {
            width: 80px;
            height: 80px;
            border-radius: 10px;
            object-fit: cover;
        }

        .item-info {
            flex-grow: 1;
        }

        .item-actions {
            display: flex;
            gap: 0.5rem;
        }

        .action-btn {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
        }

        .edit-btn {
            background: #e3f2fd;
            color: #1976d2;
        }

        .delete-btn {
            background: #ffebee;
            color: #d32f2f;
        }

        .action-btn:hover {
            transform: scale(1.1);
        }

        /* Modal */
        #item-modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 20px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .status-bar {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            padding: 1rem 2rem;
            border-radius: 10px;
            color: white;
            display: none;
            z-index: 1001;
        }

        .status-success {
            background: #2e7d32;
        }

        .status-error {
            background: #d32f2f;
        }
    </style>
</head>

<body>
    <header class="admin-header">
        <h1>Admin Control Panel</h1>
        <p>Manage your collections via GitHub Integration</p>
    </header>

    <div class="container">
        <!-- Login Section -->
        <section id="setup-section">
            <div style="text-align: center; margin-bottom: 2rem;">
                <img src="maghuva-logo.jpeg" alt="Logo" style="height: 80px; border-radius: 50%; margin-bottom: 1rem;">
                <h2>Admin Login</h2>
                <p>Enter your credentials to manage collections</p>
            </div>
            <div class="form-group">
                <label>Username</label>
                <input type="text" id="admin-user" placeholder="Enter username">
            </div>
            <div class="form-group">
                <label>Password</label>
                <input type="password" id="admin-pass" placeholder="Enter password">
            </div>
            <button class="btn" style="width: 100%;" onclick="initializeAdmin()">Login to Dashboard <i
                    class="fas fa-sign-in-alt"></i></button>
        </section>

        <!-- Admin Panel -->
        <section id="admin-panel">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                <h2><i class="fas fa-th-list"></i> Collections Dashboard</h2>
                <button class="btn" onclick="openModal()"><i class="fas fa-plus"></i> Add New Category</button>
            </div>
            <div id="items-list">
                <!-- Items will load here -->
            </div>
            <div style="margin-top: 2rem; border-top: 1px solid #ddd; padding-top: 2rem; text-align: center;">
                <button class="btn" id="save-btn" style="background: #2e7d32;" onclick="saveToGitHub(event)">Update Live
                    Website <i class="fas fa-save"></i></button>
            </div>
        </section>
    </div>

    <!-- Add/Edit Modal -->
    <div id="item-modal">
        <div class="modal-content">
            <h2 id="modal-title">Edit Category</h2>
            <form id="item-form">
                <input type="hidden" id="edit-id">
                <div class="form-group">
                    <label>Title</label>
                    <input type="text" id="item-title" required>
                </div>
                <div class="form-group">
                    <label>Image URL (e.g. 3.jpeg or online URL)</label>
                    <input type="text" id="item-image" required>
                </div>
                <div class="form-group">
                    <label>Icon Class (FontAwesome)</label>
                    <input type="text" id="item-icon" value="fas fa-star">
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="item-desc"
                        style="width: 100%; border-radius: 10px; padding: 0.8rem; height: 100px;"></textarea>
                </div>
                <div class="form-group">
                    <label>Features (Comma separated)</label>
                    <input type="text" id="item-features" placeholder="Feature 1, Feature 2, Feature 3">
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="item-reverse"> Reverse Layout (Image on right)
                    </label>
                </div>
                <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                    <button type="submit" class="btn">Save Change</button>
                    <button type="button" class="btn" style="background: #666;" onclick="closeModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <div id="status-bar" class="status-bar"></div>

    <script>
        let currentData = [];
        let config = {
            owner: 'frontend-fuel',
            repo: 'maghuvafashions',
            branch: 'main'
        };

        function showStatus(msg, isError = false) {
            const bar = document.getElementById('status-bar');
            bar.textContent = msg;
            bar.style.display = 'block';
            bar.className = 'status-bar ' + (isError ? 'status-error' : 'status-success');
            setTimeout(() => bar.style.display = 'none', 3000);
        }

        async function initializeAdmin() {
            const user = document.getElementById('admin-user').value;
            const pass = document.getElementById('admin-pass').value;

            if (user !== 'admin') {
                alert("Invalid Username!");
                return;
            }

            config.token = pass; // Using password field as the Token internally

            try {
                showStatus("Authenticating...");
                // Fetch current data.json from the repo
                const url = `https://api.github.com/repos/${config.owner}/${config.repo}/contents/data.json?ref=${config.branch}`;
                const response = await fetch(url, {
                    headers: { 'Authorization': `token ${config.token}` }
                });

                if (!response.ok) throw new Error("Login Failed! Please check your Password (Token).");

                const fileData = await response.json();
                config.sha = fileData.sha;
                currentData = JSON.parse(decodeURIComponent(escape(atob(fileData.content))));

                document.getElementById('setup-section').style.display = 'none';
                document.getElementById('admin-panel').style.display = 'block';
                renderList();
                showStatus("Logged in successfully!");
            } catch (err) {
                alert(err.message);
                showStatus("Login Failed", true);
            }
        }

        function renderList() {
            const list = document.getElementById('items-list');
            list.innerHTML = '';
            currentData.forEach((item, index) => {
                const card = document.createElement('div');
                card.className = 'item-card';
                card.innerHTML = `
                    <img src="${item.image}" alt="">
                    <div class="item-info">
                        <strong>${item.title}</strong>
                        <p style="margin:0; font-size: 0.8rem; color: #666;">${item.description.substring(0, 60)}...</p>
                    </div>
                    <div class="item-actions">
                        <div class="action-btn edit-btn" onclick="openModal(${index})"><i class="fas fa-edit"></i></div>
                        <div class="action-btn delete-btn" onclick="deleteItem(${index})"><i class="fas fa-trash"></i></div>
                    </div>
                `;
                list.appendChild(card);
            });
        }

        function openModal(index = null) {
            const modal = document.getElementById('item-modal');
            const form = document.getElementById('item-form');
            modal.style.display = 'flex';

            if (index !== null) {
                const item = currentData[index];
                document.getElementById('modal-title').textContent = 'Edit Category';
                document.getElementById('edit-id').value = index;
                document.getElementById('item-title').value = item.title;
                document.getElementById('item-image').value = item.image;
                document.getElementById('item-icon').value = item.icon || 'fas fa-star';
                document.getElementById('item-desc').value = item.description;
                document.getElementById('item-features').value = item.features.join(', ');
                document.getElementById('item-reverse').checked = !!item.reverse;
            } else {
                document.getElementById('modal-title').textContent = 'Add New Category';
                form.reset();
                document.getElementById('edit-id').value = '';
            }
        }

        function closeModal() {
            document.getElementById('item-modal').style.display = 'none';
        }

        document.getElementById('item-form').onsubmit = function (e) {
            e.preventDefault();
            const editId = document.getElementById('edit-id').value;
            const newItem = {
                id: Date.now().toString(),
                title: document.getElementById('item-title').value,
                image: document.getElementById('item-image').value,
                icon: document.getElementById('item-icon').value,
                description: document.getElementById('item-desc').value,
                features: document.getElementById('item-features').value.split(',').map(f => f.trim()),
                reverse: document.getElementById('item-reverse').checked
            };

            if (editId !== '') {
                currentData[editId] = newItem;
            } else {
                currentData.push(newItem);
            }

            closeModal();
            renderList();
            showStatus("Local change saved. Don't forget to Final Save to GitHub!");
        };

        function deleteItem(index) {
            if (confirm("Are you sure you want to delete this category?")) {
                currentData.splice(index, 1);
                renderList();
                showStatus("Item deleted from local list.");
            }
        }

        async function saveToGitHub(event) {
            if (!config.token) return;

            const btn = event.target;
            const originalText = "Finalize & Save Changes to GitHub";

            try {
                showStatus("Saving to GitHub... Please wait.");
                const content = btoa(unescape(encodeURIComponent(JSON.stringify(currentData, null, 4))));

                const response = await fetch(`https://api.github.com/repos/${config.owner}/${config.repo}/contents/data.json`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${config.token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: "Admin: Update product data",
                        content: content,
                        sha: config.sha,
                        branch: config.branch
                    })
                });

                if (!response.ok) throw new Error("GitHub Save Failed. Check your Token permissions.");

                const result = await response.json();
                config.sha = result.content.sha; // Update SHA for next save
                showStatus("SUCCESS! Website updated globally.");
            } catch (err) {
                alert(err.message);
                showStatus("Save Failed", true);
            }
        }
    </script>
</body>

</html>